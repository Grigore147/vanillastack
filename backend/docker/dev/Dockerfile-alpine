FROM node:alpine3.12
MAINTAINER maintainer_name "jurlind.budurushi@cloudical.io"

## Setting up Env
ENV PORT=8080
ENV IP=localhost
ENV NODE_ENV=development
ENV MODE=installer
EXPOSE ${PORT}
WORKDIR /usr/workdir

## Install nginx, Ansible and pre-req
RUN apk update && apk upgrade --available && sync && apk add \
    --update --no-cache openssh-client musl-dev libffi-dev openssl-dev ca-certificates python3 py3-pip python3-dev gcc make --virtual build-dependencies build-base && \
    pip3 install cffi && \ 
    pip3 install ansible && \
    ansible-galaxy collection install community.kubernetes && \
    rm -rf /var/cache/apk*

## copy app files
COPY ./package.json ./
COPY ./vue.config.js ./
COPY ./src ./src/
COPY ./public ./public/

## Install npm Modules
RUN npm install && npm audit fix

## Build and prep Frontend
RUN rm -rf ./dist/* && npm run build
RUN rm -rf ./src/public/* && cp -r ./dist/* ./src/public

## Run nginx and backend
CMD ["npm", "run", "start"]